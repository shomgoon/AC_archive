<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>üéß –ê—É–¥–∏–æ–∞—Ä—Ö–∏–≤</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; max-width: 900px; margin: 20px auto; background: #fafafa; }
    #controls { background: #f0f7ff; padding: 16px; border-radius: 8px; margin-bottom: 20px; }
    .segment { 
      padding: 12px 16px; margin: 8px 0; 
      background: white; border-left: 4px solid #4a90e2; border-radius: 4px;
      cursor: pointer; transition: all 0.2s;
    }
    .segment:hover { background: #f8fcff; transform: translateX(2px); }
    .segment.active { background: #e6f2ff; border-left-color: #e74c3c; }
    .timestamp { font-family: monospace; font-weight: bold; color: #2c3e50; margin-right: 10px; }
    #status { margin-top: 10px; padding: 6px; border-radius: 4px; }
    .success { background: #e8f5e9; color: #2e7d32; }
    .warn { background: #fff8e1; color: #5d4037; }
    .error { background: #ffebee; color: #c62828; }
  </style>
</head>
<body>
  <h1>üéß –ê—É–¥–∏–æ–∞—Ä—Ö–∏–≤</h1>

  <div id="controls">
    <p><strong>üìÅ 1. –í—ã–±–µ—Ä–∏—Ç–µ –∞—É–¥–∏–æ</strong></p>
    <input type="file" id="audioInput" accept="audio/*"><br><br>
    
    <p><strong>üìÑ 2. –í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç</strong> (.txt, .md)</p>
    <input type="file" id="transcriptInput" accept=".txt,.md">
    
    <div id="status" class="warn">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∞—É–¥–∏–æ –∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç</div>
  </div>

  <div id="transcript"></div>

  <script>
    let audio = null;
    let segments = [];

    // === –ê—É–¥–∏–æ ===
    document.getElementById('audioInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      try {
        const url = URL.createObjectURL(file);
        if (!audio) {
          audio = new Audio();
          audio.controls = true;
          audio.style.width = '100%';
          audio.style.marginTop = '12px';
          document.getElementById('controls').appendChild(audio);
        }
        audio.src = url;
        setStatus(`‚úÖ –ê—É–¥–∏–æ: ${file.name}`, 'success');
        checkReady();
      } catch (err) {
        setStatus(`‚ùå –ê—É–¥–∏–æ: ${err.message}`, 'error');
      }
    });

    // === –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç ===
    document.getElementById('transcriptInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        const text = e.target.result;
        segments = parseTranscript(text);
        render();
        setStatus(`‚úÖ –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç: ${segments.length} —Å–µ–≥–º–µ–Ω—Ç–æ–≤ (${file.name})`, 'success');
        checkReady();
      };
      reader.readAsText(file);
    });

    // === –ü–∞—Ä—Å–µ—Ä –ø–æ–¥ –≤–∞—à —Ñ–æ—Ä–º–∞—Ç: ### [00:00:00] –ó–∞–≥–æ–ª–æ–≤–æ–∫ + —Ç–µ–∫—Å—Ç ===
    function parseTranscript(text) {
      // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –º–µ—Ç–∞-–±–ª–æ–∫ (–µ—Å–ª–∏ –µ—Å—Ç—å)
      const lines = text.split('\n');
      const startIndex = lines.findIndex(line => line.trim().startsWith('### ['));
      const content = lines.slice(startIndex === -1 ? 0 : startIndex).join('\n');

      const segmentsRaw = content.split(/^(?=### \[)/m).filter(Boolean);
      return segmentsRaw.map((seg, i, arr) => {
        const headerMatch = seg.match(/^### \[(\d{1,2}):(\d{2}):(\d{2})\]\s*(.*)/);
        if (!headerMatch) return null;

        const h = parseInt(headerMatch[1]) || 0;
        const m = parseInt(headerMatch[2]) || 0;
        const s = parseInt(headerMatch[3]) || 0;
        const title = headerMatch[4] || '';
        const text = seg.split('\n').slice(1).join('\n').trim();

        const start = h * 3600 + m * 60 + s;
        const end = (i < arr.length - 1)
          ? (() => {
              const nextMatch = arr[i + 1].match(/^### \[(\d{1,2}):(\d{2}):(\d{2})\]/);
              if (nextMatch) {
                const nh = parseInt(nextMatch[1]) || 0;
                const nm = parseInt(nextMatch[2]) || 0;
                const ns = parseInt(nextMatch[3]) || 0;
                return nh * 3600 + nm * 60 + ns;
              }
              return start + 60;
            })()
          : start + 60;

        return { start, end, title, text };
      }).filter(Boolean);
    }

    // === –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ ===
    function playSegment(i) {
      const seg = segments[i];
      if (!seg || !audio) return;

      // –ê–∫—Ç–∏–≤–∞—Ü–∏—è
      document.querySelectorAll('.segment').forEach(el => el.classList.remove('active'));
      const el = document.querySelectorAll('.segment')[i];
      el?.classList.add('active');

      audio.currentTime = seg.start;
      audio.play().catch(err => {
        console.warn('–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ:', err);
        // –ë–µ–∑ –≤—Å–ø–ª—ã–≤–∞—é—â–∏—Ö –æ–∫–æ–Ω ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º –∫–ª–∏–∫–Ω–µ—Ç –ø–æ –ø–ª–µ–µ—Ä—É –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
      });

      el?.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // === –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ ===
    function render() {
      const container = document.getElementById('transcript');
      if (!segments.length) {
        container.innerHTML = '<p><i>–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–µ–≥–º–µ–Ω—Ç–æ–≤</i></p>';
        return;
      }

      container.innerHTML = segments.map((seg, i) =>
        `<div class="segment" onclick="playSegment(${i})">
          <div><span class="timestamp">[${formatTime(seg.start)}]</span> <strong>${seg.title}</strong></div>
          ${seg.text ? `<div style="margin-top:6px; font-size:0.95em;">${seg.text.replace(/\n/g, '<br>')}</div>` : ''}
        </div>`
      ).join('');
    }

    function formatTime(s) {
      s = Math.floor(s);
      const h = Math.floor(s / 3600);
      const m = Math.floor((s % 3600) / 60);
      const ss = s % 60;
      return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${ss.toString().padStart(2, '0')}`;
    }

    function setStatus(html, cls) {
      const el = document.getElementById('status');
      el.className = cls;
      el.innerHTML = html;
    }

    function checkReady() {
      if (audio && segments.length > 0) {
        setStatus('‚úÖ –ì–æ—Ç–æ–≤–æ ‚Äî –∫–ª–∏–∫–∞–π—Ç–µ –ø–æ —Ç–∞–π–º–∫–æ–¥–∞–º!', 'success');
      }
    }

    window.playSegment = playSegment;
  </script>
</body>
</html>