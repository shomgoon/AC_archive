<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <title>üéß –ê—É–¥–∏–æ–∞—Ä—Ö–∏–≤</title>
  <style>
    /* === –í–°–ï –°–¢–ò–õ–ò –í –û–î–ù–û–ú –ú–ï–°–¢–ï === */
    body {
      font-family: 'Segoe UI', sans-serif;
      max-width: 1000px;
      margin: 20px auto;
      background: #fafafa;
    }

    .container {
      display: flex;
      gap: 20px;
    }

    .sidebar {
      width: 250px;
      background: #f0f7ff;
      padding: 15px;
      border-radius: 8px;
    }

    .main {
      flex: 1;
    }

    .audio-item {
      padding: 8px 12px;
      margin: 4px 0;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .audio-item:hover {
      background: #e3f2fd;
    }

    .audio-item.active {
      background: #bbdefb;
      font-weight: bold;
    }

    .segment {
      padding: 12px 16px;
      margin: 8px 0;
      background: white;
      border-left: 4px solid #4a90e2;
      border-radius: 4px;
      cursor: pointer;
    }

    .segment:hover {
      background: #f8fcff;
    }

    .segment.active {
      background: #e6f2ff;
      border-left-color: #e74c3c;
    }

    .timestamp {
      font-family: monospace;
      font-weight: bold;
      color: #2c3e50;
      margin-right: 8px;
    }

    #status {
      margin: 10px 0;
      padding: 8px;
      border-radius: 4px;
      font-size: 0.9em;
    }

    .success {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .warn {
      background: #fff8e1;
      color: #5d4037;
    }

    .error {
      background: #ffebee;
      color: #c62828;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ */
    .search-container {
      position: relative;
      margin: 15px 0;
    }

    #searchInput {
      width: 100%;
      padding: 8px 30px 8px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
    }

    .clear-search {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #999;
    }

    /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ */
    mark {
      background-color: #ffeb3b;
      padding: 0 2px;
      border-radius: 2px;
    }
  </style>
</head>

<body>
  <h1>üéß –ê—É–¥–∏–æ–∞—Ä—Ö–∏–≤</h1>

  <!-- –ü–æ–ª–µ –ø–æ–∏—Å–∫–∞ -->
  <div class="search-container">
    <input type="text" id="searchInput" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞–º...">
    <button class="clear-search" title="–û—á–∏—Å—Ç–∏—Ç—å –ø–æ–∏—Å–∫">√ó</button>
  </div>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
  <div class="container">
    <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å–æ —Å–ø–∏—Å–∫–æ–º –∞—É–¥–∏–æ -->
    <div class="sidebar">
      <h3>üîä –ê—É–¥–∏–æ–∑–∞–ø–∏—Å–∏</h3>
      <div id="audioList">
        <p class="warn">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞...</p>
      </div>
    </div>

    <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å: –ø–ª–µ–µ—Ä –∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç -->
    <div class="main">
      <div id="player"></div>
      <div id="status" class="warn">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å—å</div>
      <div id="transcript"></div>
    </div>
  </div>

  <!-- === –í–ï–°–¨ JAVASCRIPT –ö–û–î –ù–ò–ñ–ï === -->
  <script>
    // === –ù–ê–°–¢–†–û–ô–ö–ò ===
    const AUDIO_DIR = 'audio/';      // –ü–∞–ø–∫–∞ —Å –∞—É–¥–∏–æ—Ñ–∞–π–ª–∞–º–∏
    const TRANSCRIPT_DIR = 'transcripts/'; // –ü–∞–ø–∫–∞ —Å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞–º–∏

    // === –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø –•–†–ê–ù–ï–ù–ò–Ø –î–ê–ù–ù–´–• ===
    let audio = null;           // –û–±—ä–µ–∫—Ç –∞—É–¥–∏–æ–ø–ª–µ–µ—Ä–∞
    let segments = [];          // –ú–∞—Å—Å–∏–≤ —Å–µ–≥–º–µ–Ω—Ç–æ–≤ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞
    let currentAudio = null;    // –¢–µ–∫—É—â–µ–µ –∞—É–¥–∏–æ

    // === 1. –ü–û–õ–£–ß–ï–ù–ò–ï –°–ü–ò–°–ö–ê –ê–£–î–ò–û–§–ê–ô–õ–û–í ===
    async function loadAudioList() {
      const listEl = document.getElementById('audioList');
      listEl.innerHTML = '<p class="warn">‚è≥ –ü–æ–∏—Å–∫ –∞—É–¥–∏–æ–∑–∞–ø–∏—Å–µ–π...</p>';

      try {
        // –°–ø–∏—Å–æ–∫ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ (–µ—Å–ª–∏ files.txt –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)
        const knownFiles = [
          '–∏_–ø–æ–Ω–∏–º–∞–µ—Ç–µ_–∏_—ç—Ç–æ–º—É_–≤—Å–µ–º—É_—Å–≤–æ–∏_—ç—Ç–∞–ø—ã.mp3',
          '–æ–Ω_–ø–∏—à–µ—Ç_–¥—É—Ö_—á–µ–ª–æ–≤–µ–∫–∞.mp3',
          '–ø–æ–¥–æ–∂–¥–∏_–±–∞—Ç—é—à–∫–∞_–¥–∞–π_—è_–≤–∫–ª—é—á—É.mp3'
        ];

        // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∏–∑ —Ñ–∞–π–ª–∞
        let audioFiles = knownFiles;
        try {
          const response = await fetch('files.txt');
          if (response.ok) {
            const text = await response.text();
            const filesFromFile = text.split('\n')
              .filter(line => line.trim() && (line.includes('.mp3') || line.includes('.wav') || line.includes('.ogg')))
              .map(line => line.trim());

            if (filesFromFile.length > 0) {
              audioFiles = filesFromFile;
              console.log('–ó–∞–≥—Ä—É–∂–µ–Ω —Å–ø–∏—Å–æ–∫ –∏–∑ files.txt:', audioFiles);
            }
          }
        } catch (e) {
          console.log('–ò—Å–ø–æ–ª—å–∑—É—é —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤');
        }

        // –ï—Å–ª–∏ —Ñ–∞–π–ª–æ–≤ –Ω–µ—Ç - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        if (audioFiles.length === 0) {
          listEl.innerHTML = '<p class="warn">–ù–µ—Ç –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤</p>';
          return;
        }

        // –°–æ–∑–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ –∞—É–¥–∏–æ–∑–∞–ø–∏—Å–µ–π
        listEl.innerHTML = audioFiles.map(file => {
          const displayName = file.replace(/\.(mp3|wav|ogg)$/i, '').replace(/_/g, ' ');
          return `<div class="audio-item" data-filename="${file}" onclick="loadRecording('${file}')">
                    üéß ${displayName}
                  </div>`;
        }).join('');

        setStatus(`‚úÖ –ù–∞–π–¥–µ–Ω–æ ${audioFiles.length} –∞—É–¥–∏–æ–∑–∞–ø–∏—Å–µ–π`, 'success');

      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –∞—É–¥–∏–æ:', err);
        listEl.innerHTML = `<p class="error">‚ùå ${err.message}</p>`;
        setStatus(`‚ùå –û—à–∏–±–∫–∞: ${err.message}`, 'error');
      }
    }

    // === 2. –ó–ê–ì–†–£–ó–ö–ê –ö–û–ù–ö–†–ï–¢–ù–û–ô –ê–£–î–ò–û–ó–ê–ü–ò–°–ò ===
    async function loadRecording(audioFilename) {
      // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –∞—É–¥–∏–æ
      if (audio) {
        audio.pause();
      }

      const baseName = audioFilename.replace(/\.(mp3|wav|ogg)$/i, '');
      const audioUrl = `${AUDIO_DIR}${audioFilename}`;

      setStatus(`‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞: ${baseName}...`, 'warn');

      // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –≤ —Å–ø–∏—Å–∫–µ
      document.querySelectorAll('.audio-item').forEach(el => el.classList.remove('active'));
      const activeItem = document.querySelector(`.audio-item[data-filename="${audioFilename}"]`);
      if (activeItem) {
        activeItem.classList.add('active');
      }

      try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞—É–¥–∏–æ—Ñ–∞–π–ª
        const audioBlob = await fetch(audioUrl).then(r => {
          if (!r.ok) throw new Error(`–ê—É–¥–∏–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ: ${r.status}`);
          return r.blob();
        });

        // –°–æ–∑–¥–∞–µ–º URL –¥–ª—è –∞—É–¥–∏–æ
        const audioObjectUrl = URL.createObjectURL(audioBlob);

        // –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∞—É–¥–∏–æ–ø–ª–µ–µ—Ä
        if (!audio) {
          audio = new Audio();
          audio.controls = true;
          audio.style.width = '100%';
          // –°–ª–µ–¥–∏–º –∑–∞ –≤—Ä–µ–º–µ–Ω–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
          audio.addEventListener('timeupdate', updateActiveSegment);
        }

        audio.src = audioObjectUrl;
        document.getElementById('player').innerHTML = '';
        document.getElementById('player').appendChild(audio);
        currentAudio = baseName;

        // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç
        let transcriptText = null;
        let transcriptExt = null;

        // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤
        for (const ext of ['.md', '.txt']) {
          try {
            const url = `${TRANSCRIPT_DIR}${baseName}${ext}`;
            const response = await fetch(url);
            if (response.ok) {
              transcriptText = await response.text();
              transcriptExt = ext;
              console.log(`–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç –Ω–∞–π–¥–µ–Ω: ${url}`);
              break;
            }
          } catch (e) {
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏, –ø—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π –≤–∞—Ä–∏–∞–Ω—Ç
          }
        }

        // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –ø—Ä–æ–±—É–µ–º –≤–∞—Ä–∏–∞–Ω—Ç —Å –ø—Ä–æ–±–µ–ª–∞–º–∏ –≤–º–µ—Å—Ç–æ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–π
        if (!transcriptText) {
          const nameWithSpaces = baseName.replace(/_/g, ' ');
          for (const ext of ['.md', '.txt']) {
            try {
              const url = `${TRANSCRIPT_DIR}${nameWithSpaces}${ext}`;
              const response = await fetch(url);
              if (response.ok) {
                transcriptText = await response.text();
                transcriptExt = ext;
                console.log(`–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç –Ω–∞–π–¥–µ–Ω: ${url}`);
                break;
              }
            } catch (e) {
              // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º
            }
          }
        }

        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç
        if (transcriptText) {
          segments = parseTranscript(transcriptText);
          renderTranscript();
          setStatus(`‚úÖ ${baseName} ‚Äî ${segments.length} —Å–µ–≥–º–µ–Ω—Ç–æ–≤`, 'success');
        } else {
          segments = [];
          renderTranscript();
          setStatus(`‚ö†Ô∏è –ê—É–¥–∏–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ, —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω`, 'warn');
        }

      } catch (err) {
        setStatus(`‚ùå –û—à–∏–±–∫–∞: ${err.message}`, 'error');
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø–∏—Å–∏:', err);
      }
    }

    // === 3. –ü–ê–†–°–ò–ù–ì –¢–†–ê–ù–°–ö–†–ò–ü–¢–ê (—Ä–∞–∑–±–æ—Ä —Ç–µ–∫—Å—Ç–∞) ===
    function parseTranscript(text) {
      // –£–±–∏—Ä–∞–µ–º –Ω–∞—á–∞–ª–æ (–µ—Å–ª–∏ –µ—Å—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ)
      const startIndex = text.indexOf('### [');
      if (startIndex !== -1) {
        text = text.slice(startIndex);
      }

      // –†–∞–∑–¥–µ–ª—è–µ–º –Ω–∞ —Å–µ–≥–º–µ–Ω—Ç—ã –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º
      const rawSegments = text.split(/^(?=### \[)/m).filter(Boolean);

      // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π —Å–µ–≥–º–µ–Ω—Ç
      return rawSegments.map((seg, i, arr) => {
        // –ò—â–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤–∏–¥–∞ "### [00:00:00] –¢–µ–∫—Å—Ç"
        const headerMatch = seg.match(/^### \[(\d{1,2}):(\d{2}):(\d{2})\]\s*(.*)/);
        if (!headerMatch) return null;

        // –ò–∑–≤–ª–µ–∫–∞–µ–º –≤—Ä–µ–º—è
        const h = parseInt(headerMatch[1]) || 0;
        const m = parseInt(headerMatch[2]) || 0;
        const s = parseInt(headerMatch[3]) || 0;
        const title = headerMatch[4] || '';

        // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç —Å–µ–≥–º–µ–Ω—Ç–∞
        const textLines = seg.split('\n').slice(1).filter(l => l.trim());
        const text = textLines.join('\n').trim();

        // –í—ã—á–∏—Å–ª—è–µ–º –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –∏ –∫–æ–Ω—Ü–∞
        const start = h * 3600 + m * 60 + s;
        
        // –í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è - –∏–∑ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞ –∏–ª–∏ +60 —Å–µ–∫—É–Ω–¥
        let end;
        if (i < arr.length - 1) {
          const nextMatch = arr[i + 1].match(/^### \[(\d{1,2}):(\d{2}):(\d{2})\]/);
          if (nextMatch) {
            end = (parseInt(nextMatch[1] || 0) * 3600 + parseInt(nextMatch[2] || 0) * 60 + parseInt(nextMatch[3] || 0));
          } else {
            end = start + 60;
          }
        } else {
          end = start + 60;
        }

        return { start, end, title, text };
      }).filter(Boolean); // –£–±–∏—Ä–∞–µ–º null
    }

    // === 4. –í–û–°–ü–†–û–ò–ó–í–ï–î–ï–ù–ò–ï –°–ï–ì–ú–ï–ù–¢–ê ===
    function playSegment(i) {
      const seg = segments[i];
      if (!seg || !audio) return;

      // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö —Å–µ–≥–º–µ–Ω—Ç–æ–≤
      document.querySelectorAll('.segment').forEach(el => el.classList.remove('active'));
      
      // –í—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —Å–µ–≥–º–µ–Ω—Ç
      const el = document.querySelectorAll('.segment')[i];
      if (el) {
        el.classList.add('active');
        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Å–µ–≥–º–µ–Ω—Ç—É
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }

      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º—è –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
      audio.currentTime = seg.start;
      audio.play().catch(e => {
        console.warn('–ê–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ:', e);
        setStatus('‚ñ∂Ô∏è –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É play –≤ –ø–ª–µ–µ—Ä–µ', 'warn');
      });
    }

    // === 5. –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –¢–†–ê–ù–°–ö–†–ò–ü–¢–ê ===
    function renderTranscript() {
      const el = document.getElementById('transcript');
      
      if (segments.length === 0) {
        el.innerHTML = '<p><i>–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</i></p>';
        return;
      }

      // –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞
      el.innerHTML = segments.map((seg, i) => {
        const timeFormatted = formatTime(seg.start);
        const textHTML = seg.text ? 
          `<div style="margin-top:6px;font-size:0.95em;">${seg.text.replace(/\n/g, '<br>')}</div>` : 
          '';
        
        return `<div class="segment" onclick="playSegment(${i})">
                  <div>
                    <span class="timestamp">[${timeFormatted}]</span>
                    <strong>${seg.title}</strong>
                  </div>
                  ${textHTML}
                </div>`;
      }).join('');
    }

    // === 6. –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –í–†–ï–ú–ï–ù–ò (—Å–µ–∫—É–Ω–¥—ã ‚Üí –ß–ß:–ú–ú:–°–°) ===
    function formatTime(seconds) {
      seconds = Math.floor(seconds);
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const secs = seconds % 60;
      
      // –î–æ–±–∞–≤–ª—è–µ–º –≤–µ–¥—É—â–∏–µ –Ω—É–ª–∏
      const pad = (num) => num.toString().padStart(2, '0');
      
      if (hours > 0) {
        return `${pad(hours)}:${pad(minutes)}:${pad(secs)}`;
      } else {
        return `${pad(minutes)}:${pad(secs)}`;
      }
    }

    // === 7. –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–¢–ê–¢–£–°–ê ===
    function setStatus(message, type = 'warn') {
      const el = document.getElementById('status');
      el.className = type;
      el.innerHTML = message;
    }

    // === 8. –ü–û–ò–°–ö –ü–û –¢–†–ê–ù–°–ö–†–ò–ü–¢–ê–ú ===
    function setupSearch() {
      const searchInput = document.getElementById('searchInput');
      const clearButton = document.querySelector('.clear-search');
      
      if (!searchInput) return;
      
      // –ü–æ–∏—Å–∫ –ø—Ä–∏ –≤–≤–æ–¥–µ —Ç–µ–∫—Å—Ç–∞
      searchInput.addEventListener('input', function() {
        const searchTerm = this.value.trim().toLowerCase();
        
        if (searchTerm === '') {
          // –ï—Å–ª–∏ –ø–æ–∏—Å–∫ –ø—É—Å—Ç–æ–π - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ
          renderTranscript();
          setStatus(`–ü–æ–∫–∞–∑–∞–Ω—ã –≤—Å–µ ${segments.length} —Å–µ–≥–º–µ–Ω—Ç–æ–≤`, 'success');
          return;
        }
        
        // –ò—â–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
        const filteredSegments = segments.filter(seg => {
          const titleMatch = seg.title.toLowerCase().includes(searchTerm);
          const textMatch = seg.text.toLowerCase().includes(searchTerm);
          return titleMatch || textMatch;
        });
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        const transcriptEl = document.getElementById('transcript');
        
        if (filteredSegments.length > 0) {
          transcriptEl.innerHTML = filteredSegments.map((seg, i) => {
            // –ù–∞—Ö–æ–¥–∏–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
            const originalIndex = segments.indexOf(seg);
            
            // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
            const highlight = (text) => {
              if (!text) return '';
              const regex = new RegExp(`(${searchTerm})`, 'gi');
              return text.replace(regex, '<mark>$1</mark>');
            };
            
            return `<div class="segment" onclick="playSegment(${originalIndex})">
                      <div>
                        <span class="timestamp">[${formatTime(seg.start)}]</span>
                        <strong>${highlight(seg.title)}</strong>
                      </div>
                      ${seg.text ? `<div style="margin-top:6px;font-size:0.95em;">${highlight(seg.text.replace(/\n/g, '<br>'))}</div>` : ''}
                    </div>`;
          }).join('');
          
          setStatus(`üîç –ù–∞–π–¥–µ–Ω–æ ${filteredSegments.length} —Å–µ–≥–º–µ–Ω—Ç–æ–≤ –ø–æ –∑–∞–ø—Ä–æ—Å—É "${searchTerm}"`, 'success');
        } else {
          transcriptEl.innerHTML = `<p><i>–ü–æ –∑–∞–ø—Ä–æ—Å—É "${searchTerm}" –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</i></p>`;
          setStatus(`üîç –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ –∑–∞–ø—Ä–æ—Å—É "${searchTerm}"`, 'warn');
        }
      });
      
      // –ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –ø–æ–∏—Å–∫–∞
      if (clearButton) {
        clearButton.addEventListener('click', () => {
          searchInput.value = '';
          renderTranscript();
          setStatus(`–ü–æ–∫–∞–∑–∞–Ω—ã –≤—Å–µ ${segments.length} —Å–µ–≥–º–µ–Ω—Ç–æ–≤`, 'success');
        });
      }
    }

    // === 9. –ü–û–î–°–í–ï–¢–ö–ê –¢–ï–ö–£–©–ï–ì–û –°–ï–ì–ú–ï–ù–¢–ê –ü–†–ò –í–û–°–ü–†–û–ò–ó–í–ï–î–ï–ù–ò–ò ===
    function updateActiveSegment() {
      if (!audio || segments.length === 0) return;
      
      const currentTime = audio.currentTime;
      
      // –ò—â–µ–º —Ç–µ–∫—É—â–∏–π —Å–µ–≥–º–µ–Ω—Ç
      for (let i = 0; i < segments.length; i++) {
        if (currentTime >= segments[i].start && currentTime < segments[i].end) {
          // –í—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —Å–µ–≥–º–µ–Ω—Ç
          document.querySelectorAll('.segment').forEach((el, index) => {
            if (index === i) {
              el.classList.add('active');
            } else {
              el.classList.remove('active');
            }
          });
          break;
        }
      }
    }

    // === 10. –°–û–•–†–ê–ù–ï–ù–ò–ï –°–û–°–¢–û–Ø–ù–ò–Ø (–∫–∞–∫–∞—è –∑–∞–ø–∏—Å—å –∏–≥—Ä–∞–ª–∞) ===
    function saveState() {
      if (currentAudio && audio) {
        const state = {
          audio: currentAudio,
          time: audio.currentTime,
          volume: audio.volume
        };
        localStorage.setItem('audioArchive', JSON.stringify(state));
      }
    }

    function loadState() {
      try {
        const saved = localStorage.getItem('audioArchive');
        if (saved) {
          const state = JSON.parse(saved);
          
          // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥—Ä–æ–º–∫–æ—Å—Ç—å
          if (audio && state.volume) {
            audio.volume = state.volume;
          }
        }
      } catch (e) {
        console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ');
      }
    }

    // === 11. –°–î–ï–õ–ê–ï–ú –§–£–ù–ö–¶–ò–ò –î–û–°–¢–£–ü–ù–´–ú–ò –ò–ó HTML ===
    window.playSegment = playSegment;
    window.loadRecording = loadRecording;

    // === 12. –ó–ê–ü–£–°–ö –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï –°–¢–†–ê–ù–ò–¶–´ ===
    document.addEventListener('DOMContentLoaded', () => {
      console.log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –∑–∞–ø—É—Å–∫–∞—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ...');
      
      // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∞—É–¥–∏–æ
      loadAudioList();
      
      // 2. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–æ–∏—Å–∫
      setupSearch();
      
      // 3. –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      loadState();
      
      // 4. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      window.addEventListener('beforeunload', saveState);
      
      console.log('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ!');
    });

  </script>
</body>

</html>