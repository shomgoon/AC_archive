<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <title>üéß –ê—É–¥–∏–æ–∞—Ä—Ö–∏–≤</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      max-width: 1000px;
      margin: 20px auto;
      background: #fafafa;
    }

    .container {
      display: flex;
      gap: 20px;
    }

    .sidebar {
      width: 250px;
      background: #f0f7ff;
      padding: 15px;
      border-radius: 8px;
    }

    .main {
      flex: 1;
    }

    .audio-item {
      padding: 8px 12px;
      margin: 4px 0;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .audio-item:hover {
      background: #e3f2fd;
    }

    .audio-item.active {
      background: #bbdefb;
      font-weight: bold;
    }

    .segment {
      padding: 12px 16px;
      margin: 8px 0;
      background: white;
      border-left: 4px solid #4a90e2;
      border-radius: 4px;
      cursor: pointer;
    }

    .segment:hover {
      background: #f8fcff;
    }

    .segment.active {
      background: #e6f2ff;
      border-left-color: #e74c3c;
    }

    .timestamp {
      font-family: monospace;
      font-weight: bold;
      color: #2c3e50;
      margin-right: 8px;
    }

    #status {
      margin: 10px 0;
      padding: 8px;
      border-radius: 4px;
      font-size: 0.9em;
    }

    .success {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .warn {
      background: #fff8e1;
      color: #5d4037;
    }

    .error {
      background: #ffebee;
      color: #c62828;
    }
  </style>
</head>

<body>
  <h1>üéß –ê—É–¥–∏–æ–∞—Ä—Ö–∏–≤</h1>

  <div class="container">
    <div class="sidebar">
      <h3>üîä –ê—É–¥–∏–æ–∑–∞–ø–∏—Å–∏</h3>
      <div id="audioList">
        <p class="warn">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞...</p>
      </div>
    </div>
    <div class="main">
      <div id="player"></div>
      <div id="status" class="warn">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å—å</div>
      <div id="transcript"></div>
    </div>
  </div>

  <script>
    const AUDIO_DIR = 'audio/';
    const TRANSCRIPT_DIR = 'transcripts/';
    let audio = null;
    let segments = [];
    let currentAudio = null;

    // === 1. –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤ ===
    async function loadAudioList() {
      try {
        const knownFiles = [
          '–∏_–ø–æ–Ω–∏–º–∞–µ—Ç–µ_–∏_—ç—Ç–æ–º—É_–≤—Å–µ–º—É_—Å–≤–æ–∏_—ç—Ç–∞–ø—ã.mp3',
          '–æ–Ω_–ø–∏—à–µ—Ç_–¥—É—Ö_—á–µ–ª–æ–≤–µ–∫–∞.mp3',
          '–ø–æ–¥–æ–∂–¥–∏_–±–∞—Ç—é—à–∫–∞_–¥–∞–π_—è_–≤–∫–ª—é—á—É.mp3'
        ];

        const listEl = document.getElementById('audioList');
        if (knownFiles.length === 0) {
          listEl.innerHTML = '<p class="warn">–ù–µ—Ç –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤</p>';
          return;
        }

        listEl.innerHTML = knownFiles.map(file =>
          `<div class="audio-item" data-filename="${file}" onclick="loadRecording('${file}')">
              üéß ${file.replace(/\.mp3$/, '').replace(/_/g, ' ')}
            </div>`
        ).join('');

      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –∞—É–¥–∏–æ:', err);
        document.getElementById('audioList').innerHTML = `<p class="error">‚ùå ${err.message}</p>`;
      }
    }

    // === 2. –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–ø–∏—Å–∏ –ø–æ –∏–º–µ–Ω–∏ ===
    async function loadRecording(audioFilename) {
      const baseName = audioFilename.replace(/\.(mp3|wav|ogg)$/i, '');
      const audioUrl = `${AUDIO_DIR}${audioFilename}`;
      let transcriptText = null;
      let transcriptExt = null;

      setStatus(`‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞: ${baseName}...`, 'warn');

      // –°–Ω–∏–º–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
      document.querySelectorAll('.audio-item').forEach(el => el.classList.remove('active'));
      
      // –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç –ø–æ data-filename
      const activeItem = document.querySelector(`.audio-item[data-filename="${audioFilename}"]`);
      if (activeItem) {
        activeItem.classList.add('active');
      }

      try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞—É–¥–∏–æ
        const audioBlob = await fetch(audioUrl).then(r => {
          if (!r.ok) throw new Error(`–ê—É–¥–∏–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ: ${r.status} ${r.statusText}`);
          return r.blob();
        });
        const audioObjectUrl = URL.createObjectURL(audioBlob);

        if (!audio) {
          audio = new Audio();
          audio.controls = true;
          audio.style.width = '100%';
        }
        audio.src = audioObjectUrl;
        document.getElementById('player').innerHTML = '';
        document.getElementById('player').appendChild(audio);
        currentAudio = baseName;

        // –ü—Ä–æ–±—É–µ–º —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç—ã: .md, .txt
        for (const ext of ['.md', '.txt']) {
          try {
            const url = `${TRANSCRIPT_DIR}${baseName}${ext}`;
            console.log('–ü—Ä–æ–±—É—é –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç –ø–æ –∞–¥—Ä–µ—Å—É:', url);
            const response = await fetch(url);
            if (response.ok) {
              transcriptText = await response.text();
              transcriptExt = ext;
              console.log('–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç –∑–∞–≥—Ä—É–∂–µ–Ω, –¥–ª–∏–Ω–∞:', transcriptText.length);
              break;
            }
          } catch (e) {
            console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å', ext, e.message);
          }
        }

        if (transcriptText) {
          segments = parseTranscript(transcriptText);
          renderTranscript();
          setStatus(`‚úÖ ${baseName} ‚Äî ${segments.length} —Å–µ–≥–º–µ–Ω—Ç–æ–≤ (${transcriptExt})`, 'success');
        } else {
          // –ü–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ —Ñ–∞–π–ª —Å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º (–±–µ–∑ –∑–∞–º–µ–Ω—ã –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–π)
          const alternativeNames = [
            baseName,
            baseName.replace(/_/g, ' '),
            audioFilename.replace(/\.(mp3|wav|ogg)$/i, '')
          ];
          
          for (const name of alternativeNames) {
            for (const ext of ['.md', '.txt']) {
              try {
                const url = `${TRANSCRIPT_DIR}${name}${ext}`;
                console.log('–ü—Ä–æ–±—É—é –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ –∏–º—è:', url);
                const response = await fetch(url);
                if (response.ok) {
                  transcriptText = await response.text();
                  transcriptExt = ext;
                  console.log('–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç –Ω–∞–π–¥–µ–Ω –ø–æ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–º—É –∏–º–µ–Ω–∏');
                  break;
                }
              } catch (e) {
                // –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
              }
            }
            if (transcriptText) break;
          }
          
          if (transcriptText) {
            segments = parseTranscript(transcriptText);
            renderTranscript();
            setStatus(`‚úÖ ${baseName} ‚Äî ${segments.length} —Å–µ–≥–º–µ–Ω—Ç–æ–≤ (${transcriptExt})`, 'success');
          } else {
            segments = [];
            renderTranscript();
            setStatus(`‚ö†Ô∏è –ê—É–¥–∏–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ, —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω`, 'warn');
          }
        }

      } catch (err) {
        setStatus(`‚ùå –û—à–∏–±–∫–∞: ${err.message}`, 'error');
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø–∏—Å–∏:', err);
      }
    }

    // === 3. –ü–∞—Ä—Å–µ—Ä –ø–æ–¥ –≤–∞—à —Ñ–æ—Ä–º–∞—Ç ===
    function parseTranscript(text) {
      // –£–±–∏—Ä–∞–µ–º –º–µ—Ç–∞-–±–ª–æ–∫
      const startIndex = text.indexOf('### [');
      if (startIndex !== -1) text = text.slice(startIndex);

      const rawSegments = text.split(/^(?=### \[)/m).filter(Boolean);
      return rawSegments.map((seg, i, arr) => {
        const headerMatch = seg.match(/^### \[(\d{1,2}):(\d{2}):(\d{2})\]\s*(.*)/);
        if (!headerMatch) return null;

        const h = parseInt(headerMatch[1]) || 0;
        const m = parseInt(headerMatch[2]) || 0;
        const s = parseInt(headerMatch[3]) || 0;
        const title = headerMatch[4] || '';
        const textLines = seg.split('\n').slice(1).filter(l => l.trim());
        const text = textLines.join('\n').trim();

        const start = h * 3600 + m * 60 + s;
        const nextMatch = (i < arr.length - 1)
          ? arr[i + 1].match(/^### \[(\d{1,2}):(\d{2}):(\d{2})\]/)
          : null;
        const end = nextMatch
          ? (parseInt(nextMatch[1] || 0) * 3600 + parseInt(nextMatch[2] || 0) * 60 + parseInt(nextMatch[3] || 0))
          : start + 60;

        return { start, end, title, text };
      }).filter(Boolean);
    }

    // === 4. –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ ===
    function playSegment(i) {
      const seg = segments[i];
      if (!seg || !audio) return;

      document.querySelectorAll('.segment').forEach(el => el.classList.remove('active'));
      const el = document.querySelectorAll('.segment')[i];
      el?.classList.add('active');

      audio.currentTime = seg.start;
      audio.play().catch(e => console.warn('–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ:', e));
      el?.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // === 5. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ ===
    function renderTranscript() {
      const el = document.getElementById('transcript');
      if (segments.length) {
        el.innerHTML = segments.map((seg, i) =>
          `<div class="segment" onclick="playSegment(${i})">
              <div><span class="timestamp">[${formatTime(seg.start)}]</span> <strong>${seg.title}</strong></div>
              ${seg.text ? `<div style="margin-top:6px;font-size:0.95em;">${seg.text.replace(/\n/g, '<br>')}</div>` : ''}
            </div>`
        ).join('');
      } else {
        el.innerHTML = '<p><i>–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</i></p>';
      }
    }

    function formatTime(s) {
      s = Math.floor(s);
      return [
        Math.floor(s / 3600),
        Math.floor((s % 3600) / 60),
        s % 60
      ].map(n => n.toString().padStart(2, '0')).join(':');
    }

    function setStatus(html, cls) {
      const el = document.getElementById('status');
      el.className = cls;
      el.innerHTML = html;
    }

    // === 6. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ —Ñ–∞–π–ª–æ–≤ ===
    async function discoverAudioFiles() {
      try {
        // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∏–∑ —Ñ–∞–π–ª–∞
        const response = await fetch('files.txt');
        if (response.ok) {
          const text = await response.text();
          const files = text.split('\n')
            .filter(line => line.trim() && (line.includes('.mp3') || line.includes('.wav') || line.includes('.ogg')))
            .map(line => line.trim());
          
          if (files.length > 0) {
            return files;
          }
        }
      } catch (e) {
        console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å files.txt:', e.message);
      }
      
      // –ï—Å–ª–∏ files.txt –Ω–µ—Ç –∏–ª–∏ –æ–Ω –ø—É—Å—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–ø–∏—Å–æ–∫
      return [
        '–∏_–ø–æ–Ω–∏–º–∞–µ—Ç–µ_–∏_—ç—Ç–æ–º—É_–≤—Å–µ–º—É_—Å–≤–æ–∏_—ç—Ç–∞–ø—ã.mp3',
        '–æ–Ω_–ø–∏—à–µ—Ç_–¥—É—Ö_—á–µ–ª–æ–≤–µ–∫–∞.mp3',
        '–ø–æ–¥–æ–∂–¥–∏_–±–∞—Ç—é—à–∫–∞_–¥–∞–π_—è_–≤–∫–ª—é—á—É.mp3'
      ];
    }

    // === 7. –£–ª—É—á—à–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ ===
    async function loadAudioListEnhanced() {
      const listEl = document.getElementById('audioList');
      listEl.innerHTML = '<p class="warn">‚è≥ –ü–æ–∏—Å–∫ –∞—É–¥–∏–æ–∑–∞–ø–∏—Å–µ–π...</p>';
      
      try {
        const audioFiles = await discoverAudioFiles();
        
        if (audioFiles.length === 0) {
          listEl.innerHTML = '<p class="warn">–ù–µ—Ç –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤</p>';
          return;
        }
        
        listEl.innerHTML = audioFiles.map(file => {
          const displayName = file.replace(/\.(mp3|wav|ogg)$/i, '').replace(/_/g, ' ');
          return `<div class="audio-item" data-filename="${file}" onclick="loadRecording('${file}')">
                    üéß ${displayName}
                  </div>`;
        }).join('');
        
        setStatus(`‚úÖ –ù–∞–π–¥–µ–Ω–æ ${audioFiles.length} –∞—É–¥–∏–æ–∑–∞–ø–∏—Å–µ–π`, 'success');
        
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –∞—É–¥–∏–æ:', err);
        listEl.innerHTML = `<p class="error">‚ùå ${err.message}</p>`;
        setStatus(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞: ${err.message}`, 'error');
      }
    }

    // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç–∏
    window.playSegment = playSegment;
    window.loadRecording = loadRecording;
    window.loadAudioList = loadAudioListEnhanced;

    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', () => {
      console.log('‚úÖ DOM –∑–∞–≥—Ä—É–∂–µ–Ω ‚Äî –∑–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∞—É–¥–∏–æ–∑–∞–ø–∏—Å–µ–π');
      loadAudioListEnhanced();
    });
  </script>
</body>

</html>