<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>üéß –ê—É–¥–∏–æ–∞—Ä—Ö–∏–≤</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
      /* === MOBILE FIRST: –ù–∞—á–∏–Ω–∞–µ–º —Å –º–æ–±–∏–ª—å–Ω—ã—Ö —Å—Ç–∏–ª–µ–π === */

      /* 1. –ë–ê–ó–û–í–´–ï –°–¢–ò–õ–ò –¥–ª—è –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
      * {
        box-sizing: border-box; /* –ß—Ç–æ–±—ã padding –Ω–µ –ª–æ–º–∞–ª —à–∏—Ä–∏–Ω—É */
      }

      body {
        font-family: "Segoe UI", system-ui, sans-serif;
        margin: 0;
        padding: 15px;
        background: #fafafa;
        color: #333;
        line-height: 1.5;
        font-size: 16px;
      }

      h1 {
        margin: 0 0 20px 0;
        font-size: 24px;
        color: #2c3e50;
      }

      h3 {
        margin: 0 0 15px 0;
        font-size: 18px;
        color: #34495e;
      }

      /* 2. –ü–û–ò–°–ö (–¥–ª—è –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤) */
      .search-container {
        position: relative;
        margin: 0 0 20px 0;
      }

      #searchInput {
        width: 100%;
        padding: 12px 40px 12px 15px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s;
      }

      #searchInput:focus {
        outline: none;
        border-color: #4a90e2;
      }

      .clear-search {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
        color: #999;
        padding: 0;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* 3. –ö–ù–û–ü–ö–ê –ú–û–ë–ò–õ–¨–ù–û–ì–û –ú–ï–ù–Æ */
      .mobile-menu-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        background: #4a90e2;
        color: white;
        border: none;
        padding: 14px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        margin-bottom: 15px;
        transition: background-color 0.3s;
      }

      .mobile-menu-toggle:hover {
        background: #357abd;
      }

      .mobile-menu-toggle span {
        margin-right: 10px;
        font-size: 18px;
      }

      /* 4. –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ô–ù–ï–† (–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö) */
      .container {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      /* 5. –ë–û–ö–û–í–ê–Ø –ü–ê–ù–ï–õ–¨ (—Å–∫—Ä—ã—Ç–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) */
      .sidebar {
        width: 100%;
        background: #f0f7ff;
        padding: 20px;
        border-radius: 12px;
        display: none; /* –°–∫—Ä—ã–≤–∞–µ–º –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
      }

      .sidebar.visible {
        display: block; /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ */
      }

      /* 6. –û–°–ù–û–í–ù–ê–Ø –û–ë–õ–ê–°–¢–¨ */
      .main {
        width: 100%;
      }

      /* 7. –≠–õ–ï–ú–ï–ù–¢–´ –°–ü–ò–°–ö–ê –ê–£–î–ò–û */
      .audio-item {
        padding: 14px 16px;
        margin: 8px 0;
        background: white;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid transparent;
        font-size: 16px;
        min-height: 52px; /* –î–ª—è —É–¥–æ–±–Ω–æ–≥–æ –∫–∞—Å–∞–Ω–∏—è */
        display: flex;
        align-items: center;
      }

      .audio-item:hover {
        background: #e3f2fd;
        border-color: #bbdefb;
      }

      .audio-item.active {
        background: #bbdefb;
        border-color: #4a90e2;
        font-weight: 600;
      }

      /* 8. –ê–£–î–ò–û–ü–õ–ï–ï–† */
      #player {
        margin-bottom: 20px;
      }

      #player audio {
        width: 100%;
        border-radius: 8px;
      }

      /* 9. –°–¢–ê–¢–£–° */
      #status {
        margin: 0 0 20px 0;
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 15px;
      }

      .success {
        background: #e8f5e9;
        color: #2e7d32;
        border-left: 4px solid #4caf50;
      }

      .warn {
        background: #fff8e1;
        color: #5d4037;
        border-left: 4px solid #ff9800;
      }

      .error {
        background: #ffebee;
        color: #c62828;
        border-left: 4px solid #f44336;
      }

      /* 10. –°–ï–ì–ú–ï–ù–¢–´ –¢–†–ê–ù–°–ö–†–ò–ü–¢–ê */
      .segment {
        padding: 16px;
        margin: 12px 0;
        background: white;
        border-left: 4px solid #4a90e2;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        min-height: 60px; /* –î–ª—è —É–¥–æ–±–Ω–æ–≥–æ –∫–∞—Å–∞–Ω–∏—è */
      }

      .segment:hover {
        background: #f8fcff;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .segment.active {
        background: #e6f2ff;
        border-left-color: #e74c3c;
      }

      .timestamp {
        font-family: "Roboto Mono", monospace, monospace;
        font-weight: 600;
        color: #2c3e50;
        margin-right: 10px;
        font-size: 14px;
        display: inline-block;
        margin-bottom: 5px;
      }

      /* 11. –ü–û–î–°–í–ï–¢–ö–ê –ü–û–ò–°–ö–ê */
      mark {
        background-color: #ffeb3b;
        padding: 0 2px;
        border-radius: 2px;
      }

      /* 12. –ò–ù–î–ò–ö–ê–¢–û–† –ó–ê–ì–†–£–ó–ö–ò */
      .loading-indicator {
        display: inline-block;
        width: 18px;
        height: 18px;
        border: 2px solid rgba(74, 144, 226, 0.2);
        border-top-color: #4a90e2;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 10px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* 13. –ö–ù–û–ü–ö–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ö–≠–®–ï–ú */
      .cache-controls {
        display: flex;
        gap: 10px;
        margin-top: 20px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .cache-controls button {
        padding: 10px 16px;
        border: none;
        border-radius: 6px;
        background: #f0f0f0;
        color: #555;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .cache-controls button:hover {
        background: #e0e0e0;
      }

      /* === –î–ï–°–ö–¢–û–ü–ù–ê–Ø –í–ï–†–°–ò–Ø (–æ—Ç 768px) === */
      @media (min-width: 768px) {
        body {
          max-width: 1200px;
          margin: 30px auto;
          padding: 0 30px;
        }

        h1 {
          font-size: 32px;
          margin-bottom: 30px;
        }

        h3 {
          font-size: 20px;
        }

        .mobile-menu-toggle {
          display: none; /* –°–∫—Ä—ã–≤–∞–µ–º –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ */
        }

        .container {
          flex-direction: row; /* –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ */
          gap: 30px;
        }

        .sidebar {
          display: block; /* –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º */
          width: 280px;
          flex-shrink: 0;
        }

        .main {
          flex: 1;
        }

        .audio-item {
          font-size: 15px;
          min-height: 46px;
          padding: 12px 16px;
        }

        .segment {
          min-height: auto;
          padding: 14px;
        }
      }

      /* === –ü–õ–ê–ù–®–ï–¢–´ (–æ—Ç 1024px) === */
      @media (min-width: 1024px) {
        body {
          max-width: 1400px;
        }

        .sidebar {
          width: 320px;
        }
      }

      /* === –¢–ï–ú–ù–ê–Ø –¢–ï–ú–ê (–µ—Å–ª–∏ —Å–∏—Å—Ç–µ–º–∞ –≤ —Ç–µ–º–Ω–æ–º —Ä–µ–∂–∏–º–µ) === */
      @media (prefers-color-scheme: dark) {
        body {
          background: #121212;
          color: #e0e0e0;
        }

        .sidebar {
          background: #1e1e1e;
        }

        .audio-item {
          background: #2d2d2d;
          color: #e0e0e0;
        }

        .audio-item:hover {
          background: #3d3d3d;
        }

        .audio-item.active {
          background: #2c5282;
          color: white;
        }

        .segment {
          background: #2d2d2d;
          color: #e0e0e0;
        }

        .segment:hover {
          background: #3d3d3d;
        }

        #searchInput {
          background: #2d2d2d;
          color: #e0e0e0;
          border-color: #444;
        }

        .cache-controls button {
          background: #2d2d2d;
          color: #e0e0e0;
        }

        .cache-controls button:hover {
          background: #3d3d3d;
        }
      }

      /* === –ê–ù–ò–ú–ê–¶–ò–ò –ò –ú–ò–ö–†–û–ò–ù–¢–ï–†–ê–ö–¶–ò–ò === */
      .audio-item,
      .segment,
      button {
        -webkit-tap-highlight-color: transparent; /* –£–±–∏—Ä–∞–µ–º —Å–∏–Ω–∏–π highlight –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
      }

      .audio-item:active,
      .segment:active {
        transform: scale(0.98);
      }
    </style>
  </head>

  <body>
    <h1>üéß –ê—É–¥–∏–æ–∞—Ä—Ö–∏–≤ –ê–°</h1>

    <!-- –ü–æ–ª–µ –ø–æ–∏—Å–∫–∞ -->
    <div class="search-container">
      <input
        type="text"
        id="searchInput"
        placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞–º..."
        autocomplete="off"
      />
      <button class="clear-search" title="–û—á–∏—Å—Ç–∏—Ç—å –ø–æ–∏—Å–∫">√ó</button>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –º–æ–±–∏–ª—å–Ω–æ–≥–æ –º–µ–Ω—é -->
    <button class="mobile-menu-toggle" id="mobileMenuToggle">
      <span>‚ò∞</span> –°–ø–∏—Å–æ–∫ –∞—É–¥–∏–æ–∑–∞–ø–∏—Å–µ–π
    </button>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
    <div class="container">
      <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å–æ —Å–ø–∏—Å–∫–æ–º –∞—É–¥–∏–æ -->
      <div class="sidebar" id="sidebar">
        <h3>üîä –ê—É–¥–∏–æ</h3>
        <div id="audioList">
          <p class="warn">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞...</p>
        </div>
      </div>

      <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å: –ø–ª–µ–µ—Ä –∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç -->
      <div class="main">
        <div id="player"></div>
        <div id="status" class="warn">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å—å –∏–∑ —Å–ø–∏—Å–∫–∞</div>
        <div id="transcript"></div>
      </div>
    </div>

    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—ç—à–µ–º -->
    <div class="cache-controls">
      <button onclick="showCacheInfo()">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫—ç—à–∞</button>
      <button onclick="clearCache()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à</button>
    </div>

    <!-- === JAVASCRIPT –ö–û–î === -->
    <script>
      // === –ö–û–ù–°–¢–ê–ù–¢–´ –ò –ü–ï–†–ï–ú–ï–ù–ù–´–ï ===
      const AUDIO_DIR = "audio/";
      const TRANSCRIPT_DIR = "transcripts/";

      let audio = null;
      let segments = [];
      let currentAudio = null;

      // === –ö–≠–®–ò–†–û–í–ê–ù–ò–ï ===
      const transcriptCache = new Map();
      const audioCache = new Map();
      const loadingState = new Map();

      // === 1. –ó–ê–ì–†–£–ó–ö–ê –°–ü–ò–°–ö–ê –ê–£–î–ò–û (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è) ===
      async function loadAudioList() {
        const listEl = document.getElementById("audioList");
        listEl.innerHTML = '<p class="warn">‚è≥ –ü–æ–∏—Å–∫ –∞—É–¥–∏–æ–∑–∞–ø–∏—Å–µ–π...</p>';

        try {
          let audioFiles = [];

          // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å files.txt
          try {
            const response = await fetch("files.txt");
            if (response.ok) {
              const text = await response.text();
              console.log("‚úÖ files.txt –∑–∞–≥—Ä—É–∂–µ–Ω, —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ:", text);

              audioFiles = text
                .split(/\r?\n/) // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ª—é–±—ã–µ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
                .map((line) => line.trim()) // –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã
                .filter((line) => {
                  const cleanLine = line.replace(/^\uFEFF/, ""); // –£–±–∏—Ä–∞–µ–º BOM –µ—Å–ª–∏ –µ—Å—Ç—å
                  return cleanLine && /\.(mp3|wav|ogg)$/i.test(cleanLine);
                })
                .map((line) => line.replace(/^\uFEFF/, "").trim()); // –û—á–∏—â–∞–µ–º –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ

              console.log("üìÅ –ù–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª–æ–≤:", audioFiles.length, audioFiles);
            }
          } catch (e) {
            console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ files.txt:", e);
            throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤");
          }

          // –£–ë–ò–†–ê–ï–ú —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–ø–∏—Å–æ–∫ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –¢–û–õ–¨–ö–û files.txt
          if (audioFiles.length === 0) {
            listEl.innerHTML = `
        <p class="error">
          ‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤.<br>
          –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª files.txt —Å–æ —Å–ø–∏—Å–∫–æ–º MP3 —Ñ–∞–π–ª–æ–≤.
        </p>`;
            setStatus(`‚ùå –ù–µ—Ç –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤`, "error");
            return;
          }

          // –°–æ–∑–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏
          listEl.innerHTML = audioFiles
            .map((file) => {
              const baseName = file.replace(/\.(mp3|wav|ogg)$/i, "");
              const fullName = baseName.replace(/_/g, " ");

              // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º –¥–ª–∏–Ω—É –Ω–∞–∑–≤–∞–Ω–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
              let displayName = fullName;
              const isMobile = window.innerWidth <= 768;

              if (isMobile && fullName.length > 25) {
                displayName = fullName.substring(0, 22) + "...";
              }

              const isCached = transcriptCache.has(baseName);
              const cacheIcon = isCached ? " üíæ" : "";

              return `<div class="audio-item" data-filename="${file}" 
                  onclick="loadRecording('${file}')" title="${fullName}">
                  üéß ${displayName}${cacheIcon}
                </div>`;
            })
            .join("");

          setStatus(`‚úÖ –ù–∞–π–¥–µ–Ω–æ ${audioFiles.length} –∞—É–¥–∏–æ–∑–∞–ø–∏—Å–µ–π`, "success");
        } catch (err) {
          console.error("–û—à–∏–±–∫–∞:", err);
          listEl.innerHTML = `<p class="error">‚ùå ${err.message}</p>`;
          setStatus(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏`, "error");
        }
      }

      // === 2. –ó–ê–ì–†–£–ó–ö–ê –ê–£–î–ò–û–ó–ê–ü–ò–°–ò ===
      async function loadRecording(audioFilename) {
        const baseName = audioFilename.replace(/\.(mp3|wav|ogg)$/i, "");

        if (loadingState.get(baseName)) return;
        loadingState.set(baseName, true);

        const audioUrl = `${AUDIO_DIR}${audioFilename}`;
        setStatus(
          `<span class="loading-indicator"></span> –ó–∞–≥—Ä—É–∑–∫–∞: ${baseName.replace(
            /_/g,
            " "
          )}...`,
          "warn"
        );

        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
        document.querySelectorAll(".audio-item").forEach((el) => {
          el.classList.remove("active");
          const filename = el.getAttribute("data-filename");
          if (filename) {
            const name = filename.replace(/\.(mp3|wav|ogg)$/i, "");
            if (loadingState.get(name)) {
              el.innerHTML = el.innerHTML.replace("üéß", "‚è≥");
            }
          }
        });

        const activeItem = document.querySelector(
          `.audio-item[data-filename="${audioFilename}"]`
        );
        if (activeItem) {
          activeItem.classList.add("active");
          activeItem.innerHTML = activeItem.innerHTML.replace("üéß", "‚è≥");
        }

        try {
          // –ó–∞–≥—Ä—É–∑–∫–∞ –∞—É–¥–∏–æ —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
          let audioObjectUrl;
          if (audioCache.has(audioUrl)) {
            console.log("–ö—ç—à –∞—É–¥–∏–æ:", baseName);
            audioObjectUrl = audioCache.get(audioUrl);
          } else {
            const audioBlob = await fetch(audioUrl).then((r) => {
              if (!r.ok) throw new Error(`–ê—É–¥–∏–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ: ${r.status}`);
              return r.blob();
            });
            audioObjectUrl = URL.createObjectURL(audioBlob);
            audioCache.set(audioUrl, audioObjectUrl);
          }

          // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–ª–µ–µ—Ä–∞
          if (!audio) {
            audio = new Audio();
            audio.controls = true;
            audio.style.width = "100%";
            audio.addEventListener("timeupdate", updateActiveSegment);
          }

          audio.src = audioObjectUrl;
          document.getElementById("player").innerHTML = "";
          document.getElementById("player").appendChild(audio);
          currentAudio = baseName;

          // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞ —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
          if (transcriptCache.has(baseName)) {
            console.log("–ö—ç—à —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞:", baseName);
            segments = transcriptCache.get(baseName);
            renderTranscript();
            setStatus(
              `‚úÖ ${baseName.replace(/_/g, " ")} (–∏–∑ –∫—ç—à–∞) ‚Äî ${
                segments.length
              } —Å–µ–≥–º–µ–Ω—Ç–æ–≤`,
              "success"
            );
            updateCacheIcons();
          } else {
            const transcriptData = await loadTranscriptFile(baseName);

            if (transcriptData) {
              segments = parseTranscript(transcriptData.text);
              transcriptCache.set(baseName, segments);
              console.log("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –∫—ç—à:", baseName);

              renderTranscript();
              setStatus(
                `‚úÖ ${baseName.replace(/_/g, " ")} ‚Äî ${
                  segments.length
                } —Å–µ–≥–º–µ–Ω—Ç–æ–≤`,
                "success"
              );
              updateCacheIcons();
            } else {
              segments = [];
              renderTranscript();
              setStatus(`‚ö†Ô∏è –ê—É–¥–∏–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ, —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω`, "warn");
            }
          }

          // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞
          closeMobileMenu();
        } catch (err) {
          setStatus(`‚ùå –û—à–∏–±–∫–∞: ${err.message}`, "error");
          console.error("–û—à–∏–±–∫–∞:", err);
        } finally {
          loadingState.set(baseName, false);
          if (activeItem && !transcriptCache.has(baseName)) {
            const displayName = audioFilename
              .replace(/\.(mp3|wav|ogg)$/i, "")
              .replace(/_/g, " ");
            activeItem.innerHTML = `üéß ${displayName}`;
          }
        }
      }

      // === 3. –ó–ê–ì–†–£–ó–ö–ê –§–ê–ô–õ–ê –¢–†–ê–ù–°–ö–†–ò–ü–¢–ê ===
      async function loadTranscriptFile(baseName) {
        const extensions = [".md", ".txt"];
        const nameVariants = [baseName, baseName.replace(/_/g, " ")];

        for (const name of nameVariants) {
          for (const ext of extensions) {
            const url = `${TRANSCRIPT_DIR}${name}${ext}`;
            try {
              const response = await fetch(url);
              if (response.ok) {
                return { text: await response.text(), ext };
              }
            } catch (e) {}
          }
        }
        return null;
      }

      // === 4. –ü–ê–†–°–ò–ù–ì –¢–†–ê–ù–°–ö–†–ò–ü–¢–ê ===
      function parseTranscript(text) {
        const startIndex = text.indexOf("### [");
        if (startIndex !== -1) text = text.slice(startIndex);

        const rawSegments = text.split(/^(?=### \[)/m).filter(Boolean);

        return rawSegments
          .map((seg, i, arr) => {
            const headerMatch = seg.match(
              /^### \[(\d{1,2}):(\d{2}):(\d{2})\]\s*(.*)/
            );
            if (!headerMatch) return null;

            const h = parseInt(headerMatch[1]) || 0;
            const m = parseInt(headerMatch[2]) || 0;
            const s = parseInt(headerMatch[3]) || 0;
            const title = headerMatch[4] || "";
            const textLines = seg
              .split("\n")
              .slice(1)
              .filter((l) => l.trim());
            const text = textLines.join("\n").trim();
            const start = h * 3600 + m * 60 + s;

            const nextMatch =
              i < arr.length - 1
                ? arr[i + 1].match(/^### \[(\d{1,2}):(\d{2}):(\d{2})\]/)
                : null;
            const end = nextMatch
              ? parseInt(nextMatch[1] || 0) * 3600 +
                parseInt(nextMatch[2] || 0) * 60 +
                parseInt(nextMatch[3] || 0)
              : start + 60;

            return { start, end, title, text };
          })
          .filter(Boolean);
      }

      // === 5. –í–û–°–ü–†–û–ò–ó–í–ï–î–ï–ù–ò–ï –°–ï–ì–ú–ï–ù–¢–ê ===
      function playSegment(i) {
        const seg = segments[i];
        if (!seg || !audio) return;

        document
          .querySelectorAll(".segment")
          .forEach((el) => el.classList.remove("active"));
        const el = document.querySelectorAll(".segment")[i];
        el?.classList.add("active");

        audio.currentTime = seg.start;
        audio.play().catch((e) => {
          setStatus("‚ñ∂Ô∏è –ù–∞–∂–º–∏—Ç–µ play –≤ –ø–ª–µ–µ—Ä–µ", "warn");
        });

        el?.scrollIntoView({ behavior: "smooth", block: "center" });
      }

      // === 6. –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –¢–†–ê–ù–°–ö–†–ò–ü–¢–ê ===
      function renderTranscript() {
        const el = document.getElementById("transcript");

        if (segments.length === 0) {
          el.innerHTML = "<p><i>–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</i></p>";
          return;
        }

        el.innerHTML = segments
          .map((seg, i) => {
            const timeFormatted = formatTime(seg.start);
            const textHTML = seg.text
              ? `<div style="margin-top:8px;font-size:0.95em;">${seg.text.replace(
                  /\n/g,
                  "<br>"
                )}</div>`
              : "";

            return `<div class="segment" onclick="playSegment(${i})">
                  <div>
                    <span class="timestamp">[${timeFormatted}]</span>
                    <strong>${seg.title}</strong>
                  </div>
                  ${textHTML}
                </div>`;
          })
          .join("");
      }

      // === 7. –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –í–†–ï–ú–ï–ù–ò ===
      function formatTime(seconds) {
        seconds = Math.floor(seconds);
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;

        const pad = (num) => num.toString().padStart(2, "0");

        if (hours > 0) {
          return `${pad(hours)}:${pad(minutes)}:${pad(secs)}`;
        } else {
          return `${pad(minutes)}:${pad(secs)}`;
        }
      }

      // === 8. –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–¢–ê–¢–£–°–ê ===
      function setStatus(message, type = "warn") {
        const el = document.getElementById("status");
        el.className = type;
        el.innerHTML = message;
      }

      // === 9. –ü–û–ò–°–ö –ü–û –¢–†–ê–ù–°–ö–†–ò–ü–¢–ê–ú ===
      function setupSearch() {
        const searchInput = document.getElementById("searchInput");
        const clearButton = document.querySelector(".clear-search");

        if (!searchInput) return;

        searchInput.addEventListener("input", function () {
          const searchTerm = this.value.trim().toLowerCase();

          if (searchTerm === "") {
            renderTranscript();
            setStatus(`–ü–æ–∫–∞–∑–∞–Ω—ã –≤—Å–µ ${segments.length} —Å–µ–≥–º–µ–Ω—Ç–æ–≤`, "success");
            return;
          }

          const filteredSegments = segments.filter(
            (seg) =>
              seg.title.toLowerCase().includes(searchTerm) ||
              seg.text.toLowerCase().includes(searchTerm)
          );

          const transcriptEl = document.getElementById("transcript");

          if (filteredSegments.length > 0) {
            transcriptEl.innerHTML = filteredSegments
              .map((seg, i) => {
                const originalIndex = segments.indexOf(seg);
                const highlight = (text) =>
                  text
                    ? text.replace(
                        new RegExp(`(${searchTerm})`, "gi"),
                        "<mark>$1</mark>"
                      )
                    : "";

                return `<div class="segment" onclick="playSegment(${originalIndex})">
                      <div>
                        <span class="timestamp">[${formatTime(
                          seg.start
                        )}]</span>
                        <strong>${highlight(seg.title)}</strong>
                      </div>
                      ${
                        seg.text
                          ? `<div style="margin-top:8px;font-size:0.95em;">${highlight(
                              seg.text.replace(/\n/g, "<br>")
                            )}</div>`
                          : ""
                      }
                    </div>`;
              })
              .join("");

            setStatus(
              `üîç –ù–∞–π–¥–µ–Ω–æ ${filteredSegments.length} —Å–µ–≥–º–µ–Ω—Ç–æ–≤`,
              "success"
            );
          } else {
            transcriptEl.innerHTML = `<p><i>–ü–æ –∑–∞–ø—Ä–æ—Å—É "${searchTerm}" –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</i></p>`;
            setStatus(`üîç –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ`, "warn");
          }
        });

        if (clearButton) {
          clearButton.addEventListener("click", () => {
            searchInput.value = "";
            renderTranscript();
            setStatus(`–ü–æ–∫–∞–∑–∞–Ω—ã –≤—Å–µ ${segments.length} —Å–µ–≥–º–µ–Ω—Ç–æ–≤`, "success");
          });
        }
      }

      // === 10. –ú–û–ë–ò–õ–¨–ù–û–ï –ú–ï–ù–Æ ===
      function setupMobileMenu() {
        const toggleButton = document.getElementById("mobileMenuToggle");
        const sidebar = document.getElementById("sidebar");

        if (!toggleButton || !sidebar) return;

        toggleButton.addEventListener("click", () => {
          sidebar.classList.toggle("visible");
          const icon = toggleButton.querySelector("span");
          icon.textContent = sidebar.classList.contains("visible") ? "‚úï" : "‚ò∞";
        });
      }

      function closeMobileMenu() {
        if (window.innerWidth <= 768) {
          const sidebar = document.getElementById("sidebar");
          const toggleButton = document.getElementById("mobileMenuToggle");
          if (sidebar && toggleButton) {
            sidebar.classList.remove("visible");
            toggleButton.querySelector("span").textContent = "‚ò∞";
          }
        }
      }

      // === 11. –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–≠–®–ï–ú ===
      function updateCacheIcons() {
        document.querySelectorAll(".audio-item").forEach((el) => {
          const filename = el.getAttribute("data-filename");
          if (filename) {
            const baseName = filename.replace(/\.(mp3|wav|ogg)$/i, "");
            if (transcriptCache.has(baseName) && !el.innerHTML.includes("üíæ")) {
              el.innerHTML = el.innerHTML.replace("üéß", "üéßüíæ");
            }
          }
        });
      }

      function clearCache() {
        transcriptCache.clear();
        audioCache.forEach((url) => URL.revokeObjectURL(url));
        audioCache.clear();

        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫–∏
        document.querySelectorAll(".audio-item").forEach((el) => {
          el.innerHTML = el.innerHTML.replace("üíæ", "");
        });

        setStatus("‚úÖ –ö—ç—à –æ—á–∏—â–µ–Ω", "success");
        console.log("–ö—ç—à –æ—á–∏—â–µ–Ω");
      }

      function showCacheInfo() {
        const info = `–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–æ–≤: ${transcriptCache.size}, –ê—É–¥–∏–æ: ${audioCache.size}`;
        setStatus(`üíæ –ö—ç—à: ${info}`, "success");
        console.log("–ö—ç—à:", info);
      }

      // === 12. –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ===
      function updateActiveSegment() {
        if (!audio || segments.length === 0) return;

        const currentTime = audio.currentTime;
        document.querySelectorAll(".segment").forEach((el, i) => {
          const seg = segments[i];
          if (seg && currentTime >= seg.start && currentTime < seg.end) {
            el.classList.add("active");
          } else {
            el.classList.remove("active");
          }
        });
      }

      // === 13. –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ –ü–†–ò –ò–ó–ú–ï–ù–ï–ù–ò–ò –†–ê–ó–ú–ï–†–ê ===
      let resizeTimeout;
      window.addEventListener("resize", () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø
          if (window.innerWidth > 768) {
            closeMobileMenu();
          }
        }, 250);
      });

      // === 14. –≠–ö–°–ü–û–†–¢ –§–£–ù–ö–¶–ò–ô ===
      window.playSegment = playSegment;
      window.loadRecording = loadRecording;
      window.clearCache = clearCache;
      window.showCacheInfo = showCacheInfo;

      // === 15. –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ===
      document.addEventListener("DOMContentLoaded", () => {
        console.log("üöÄ –ó–∞–ø—É—Å–∫ –∞—É–¥–∏–æ–∞—Ä—Ö–∏–≤–∞...");

        loadAudioList();
        setupSearch();
        setupMobileMenu();

        // –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
        window.addEventListener("beforeunload", () => {
          audioCache.forEach((url) => URL.revokeObjectURL(url));
        });

        console.log("‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ");
      });
    </script>
  </body>
</html>
