<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>üéß –ê—É–¥–∏–æ–∞—Ä—Ö–∏–≤</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; max-width: 1000px; margin: 20px auto; background: #fafafa; }
    .container { display: flex; gap: 20px; }
    .sidebar { width: 250px; background: #f0f7ff; padding: 15px; border-radius: 8px; }
    .main { flex: 1; }
    .audio-item { 
      padding: 8px 12px; margin: 4px 0; 
      background: white; border-radius: 4px; cursor: pointer;
      transition: all 0.2s;
    }
    .audio-item:hover { background: #e3f2fd; }
    .audio-item.active { background: #bbdefb; font-weight: bold; }
    .segment { 
      padding: 12px 16px; margin: 8px 0; 
      background: white; border-left: 4px solid #4a90e2; border-radius: 4px;
      cursor: pointer;
    }
    .segment:hover { background: #f8fcff; }
    .segment.active { background: #e6f2ff; border-left-color: #e74c3c; }
    .timestamp { font-family: monospace; font-weight: bold; color: #2c3e50; margin-right: 8px; }
    #status { margin: 10px 0; padding: 8px; border-radius: 4px; font-size: 0.9em; }
    .success { background: #e8f5e9; color: #2e7d32; }
    .warn { background: #fff8e1; color: #5d4037; }
    .error { background: #ffebee; color: #c62828; }
  </style>
</head>
<body>
  <h1>üéß –ê—É–¥–∏–æ–∞—Ä—Ö–∏–≤</h1>
  
  <div class="container">
    <div class="sidebar">
      <h3>üîä –ê—É–¥–∏–æ–∑–∞–ø–∏—Å–∏</h3>
      <div id="audioList">
        <p class="warn">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞...</p>
      </div>
    </div>
    <div class="main">
      <div id="player"></div>
      <div id="status" class="warn">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å—å</div>
      <div id="transcript"></div>
    </div>
  </div>

  <script>
    const AUDIO_DIR = 'audio/';
    const TRANSCRIPT_DIR = 'transcripts/';
    let audio = null;
    let segments = [];
    let currentAudio = null;

    // === 1. –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤ ===
    async function loadAudioList() {
      try {
        // GitHub Pages –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç directory listing ‚Üí 
        // –ø–æ—ç—Ç–æ–º—É **–≤—Ä—É—á–Ω—É—é –∑–∞–¥–∞—ë–º —Å–ø–∏—Å–æ–∫** (–ø–æ–∫–∞)
        // –ü–æ–∑–∂–µ –º–æ–∂–Ω–æ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å API-—Ñ–∞–π–ª
        
        const knownFiles = [
          'ponimaete_etapy.mp3',
          'beseda_o_molitve.mp3',
          // –¥–æ–±–∞–≤—å—Ç–µ —Å–≤–æ–∏
        ];

        const listEl = document.getElementById('audioList');
        if (knownFiles.length === 0) {
          listEl.innerHTML = '<p class="warn">–ù–µ—Ç –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤</p>';
          return;
        }

        listEl.innerHTML = knownFiles.map(file => 
          `<div class="audio-item" onclick="loadRecording('${file}')">
            üéß ${file.replace(/\.mp3$/, '').replace(/_/g, ' ')}
          </div>`
        ).join('');
      } catch (err) {
        document.getElementById('audioList').innerHTML = `<p class="error">‚ùå ${err.message}</p>`;
      }
    }

    // === 2. –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–ø–∏—Å–∏ –ø–æ –∏–º–µ–Ω–∏ ===
    async function loadRecording(audioFilename) {
      const baseName = audioFilename.replace(/\.(mp3|wav|ogg)$/i, '');
      const audioUrl = `${AUDIO_DIR}${audioFilename}`;
      let transcriptText = null;
      let transcriptExt = null;

      setStatus(`‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞: ${baseName}...`, 'warn');

      // –°–Ω–∏–º–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
      document.querySelectorAll('.audio-item').forEach(el => el.classList.remove('active'));
      event?.currentTarget?.classList.add('active');

      try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞—É–¥–∏–æ
        const audioBlob = await fetch(audioUrl).then(r => {
          if (!r.ok) throw new Error(`–ê—É–¥–∏–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ: ${r.status}`);
          return r.blob();
        });
        const audioObjectUrl = URL.createObjectURL(audioBlob);

        if (!audio) {
          audio = new Audio();
          audio.controls = true;
          audio.style.width = '100%';
        }
        audio.src = audioObjectUrl;
        document.getElementById('player').innerHTML = '';
        document.getElementById('player').appendChild(audio);
        currentAudio = baseName;

        // –ü—Ä–æ–±—É–µ–º —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç—ã: .md, .txt
        for (const ext of ['.md', '.txt']) {
          try {
            const url = `${TRANSCRIPT_DIR}${baseName}${ext}`;
            const response = await fetch(url);
            if (response.ok) {
              transcriptText = await response.text();
              transcriptExt = ext;
              break;
            }
          } catch (e) {
            // –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
          }
        }

        if (transcriptText) {
          segments = parseTranscript(transcriptText);
          renderTranscript();
          setStatus(`‚úÖ ${baseName} ‚Äî ${segments.length} —Å–µ–≥–º–µ–Ω—Ç–æ–≤ (${transcriptExt})`, 'success');
        } else {
          segments = [];
          renderTranscript();
          setStatus(`‚ö†Ô∏è –ê—É–¥–∏–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ, —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω`, 'warn');
        }

      } catch (err) {
        setStatus(`‚ùå –û—à–∏–±–∫–∞: ${err.message}`, 'error');
        console.error(err);
      }
    }

    // === 3. –ü–∞—Ä—Å–µ—Ä –ø–æ–¥ –≤–∞—à —Ñ–æ—Ä–º–∞—Ç ===
    function parseTranscript(text) {
      // –£–±–∏—Ä–∞–µ–º –º–µ—Ç–∞-–±–ª–æ–∫
      const startIndex = text.indexOf('### [');
      if (startIndex !== -1) text = text.slice(startIndex);

      const rawSegments = text.split(/^(?=### \[)/m).filter(Boolean);
      return rawSegments.map((seg, i, arr) => {
        const headerMatch = seg.match(/^### \[(\d{1,2}):(\d{2}):(\d{2})\]\s*(.*)/);
        if (!headerMatch) return null;

        const h = parseInt(headerMatch[1]) || 0;
        const m = parseInt(headerMatch[2]) || 0;
        const s = parseInt(headerMatch[3]) || 0;
        const title = headerMatch[4] || '';
        const textLines = seg.split('\n').slice(1).filter(l => l.trim());
        const text = textLines.join('\n').trim();

        const start = h * 3600 + m * 60 + s;
        const nextMatch = (i < arr.length - 1) 
          ? arr[i + 1].match(/^### \[(\d{1,2}):(\d{2}):(\d{2})\]/) 
          : null;
        const end = nextMatch 
          ? (parseInt(nextMatch[1] || 0) * 3600 + parseInt(nextMatch[2] || 0) * 60 + parseInt(nextMatch[3] || 0))
          : start + 60;

        return { start, end, title, text };
      }).filter(Boolean);
    }

    // === 4. –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ ===
    function playSegment(i) {
      const seg = segments[i];
      if (!seg || !audio) return;

      document.querySelectorAll('.segment').forEach(el => el.classList.remove('active'));
      const el = document.querySelectorAll('.segment')[i];
      el?.classList.add('active');

      audio.currentTime = seg.start;
      audio.play().catch(e => console.warn('–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ:', e));
      el?.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // === 5. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ ===
    function renderTranscript() {
      const el = document.getElementById('transcript');
      el.innerHTML = segments.length 
        ? segments.map((seg, i) =>
            `<div class="segment" onclick="playSegment(${i})">
              <div><span class="timestamp">[${formatTime(seg.start)}]</span> <strong>${seg.title}</strong></div>
              ${seg.text ? `<div style="margin-top:6px;font-size:0.95em;">${seg.text.replace(/\n/g, '<br>')}</div>` : ''}
            </div>`
          ).join('')
        : '<p><i>–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</i></p>';
    }

    function formatTime(s) {
      s = Math.floor(s);
      return [
        Math.floor(s / 3600),
        Math.floor((s % 3600) / 60),
        s % 60
      ].map(n => n.toString().padStart(2, '0')).join(':');
    }

    function setStatus(html, cls) {
      const el = document.getElementById('status');
      el.className = cls;
      el.innerHTML = html;
    }

    window.playSegment = playSegment;
    window.loadRecording = loadRecording;

    // –ó–∞–ø—É—Å–∫
    document.addEventListener('DOMContentLoaded', loadAudioList);
  </script>
</body>
</html>