<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ê—É–¥–∏–æ–∞—Ä—Ö–∏–≤ ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; max-width: 900px; margin: 20px auto; background: #fafafa; }
    #controls { background: #f0f7ff; padding: 16px; border-radius: 8px; margin-bottom: 20px; }
    .segment { 
      padding: 12px 16px; margin: 8px 0; 
      background: white; border-left: 4px solid #4a90e2; border-radius: 4px;
      cursor: pointer; transition: all 0.2s;
    }
    .segment:hover { background: #f8fcff; transform: translateX(2px); }
    .segment.active { background: #e6f2ff; border-left-color: #e74c3c; }
    .timestamp { font-family: monospace; font-weight: bold; color: #2c3e50; margin-right: 10px; }
    #status { margin-top: 10px; padding: 6px; border-radius: 4px; }
    .success { background: #e8f5e9; color: #2e7d32; }
    .warn { background: #fff8e1; color: #5d4037; }
    .error { background: #ffebee; color: #c62828; }
  </style>
</head>
<body>
  <h1>üéß –ê—É–¥–∏–æ–∞—Ä—Ö–∏–≤ ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞</h1>

  <div id="controls">
    <p><strong>üìÅ –í—ã–±–µ—Ä–∏—Ç–µ –∞—É–¥–∏–æ—Ñ–∞–π–ª</strong> ‚Äî —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç —Å —Ç–µ–º –∂–µ –∏–º–µ–Ω–µ–º –ø–æ–¥–≥—Ä—É–∑–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</p>
    <input type="file" id="audioInput" accept="audio/*">
    <div id="status" class="warn">–û–∂–∏–¥–∞–Ω–∏–µ –∞—É–¥–∏–æ...</div>
  </div>

  <div id="transcript"></div>

  <script>
    let audio = null;
    let segments = [];
    let currentSegment = -1;

    // === –û—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –∞—É–¥–∏–æ ===
    document.getElementById('audioInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const baseName = file.name.replace(/\.(mp3|wav|ogg|m4a|aac)$/i, '');
      setStatus(`üîé –ò—â—É —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç: <code>${baseName}.txt</code> –∏–ª–∏ <code>${baseName}.md</code>...`, 'warn');

      // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ
      segments = [];

      try {
        // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –∞—É–¥–∏–æ –∫–∞–∫ Blob (–¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ–≥–æ seek)
        const arrayBuf = await file.arrayBuffer();
        const blobUrl = URL.createObjectURL(new Blob([arrayBuf]));
        
        if (!audio) {
          audio = new Audio();
          audio.controls = true;
          audio.style.width = '100%';
          audio.style.marginTop = '12px';
          document.getElementById('controls').appendChild(audio);
        }
        audio.src = blobUrl;
        audio.load();

        // 2. –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç: —Å–Ω–∞—á–∞–ª–∞ .txt, –ø–æ—Ç–æ–º .md
        let transcriptText = null;
        let foundExt = null;

        for (const ext of ['.txt', '.md']) {
          try {
            const url = `transcripts/${encodeURIComponent(baseName)}${ext}`;
            const response = await fetch(url);
            if (response.ok) {
              transcriptText = await response.text();
              foundExt = ext;
              break;
            }
          } catch (err) {
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ ‚Äî —Ñ–∞–π–ª –º–æ–∂–µ—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å
          }
        }

        if (transcriptText !== null) {
          segments = parseTranscript(transcriptText);
          render();
          setStatus(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ: <strong>${file.name}</strong> + <code>${baseName}${foundExt}</code> (${segments.length} —Å–µ–≥–º–µ–Ω—Ç–æ–≤)`, 'success');
        } else {
          segments = [];
          render();
          setStatus(`‚ö†Ô∏è –ê—É–¥–∏–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ, –Ω–æ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω. –û–∂–∏–¥–∞—é: <code>transcripts/${baseName}.txt</code>`, 'warn');
        }

      } catch (err) {
        setStatus(`‚ùå –û—à–∏–±–∫–∞: ${err.message}`, 'error');
        console.error(err);
      }
    });

    // === –ü–∞—Ä—Å–µ—Ä ‚Äî –≥–∏–±–∫–∏–π: [00:00:00] –∏ 00:00:00 ===
    function parseTranscript(text) {
      const lines = text.split('\n');
      const segs = [];
      let current = null;

      for (let line of lines) {
        line = line.trim();
        if (!line) continue;

        // –ü–æ–¥–¥–µ—Ä–∂–∫–∞: [00:01:23] —Ç–µ–∫—Å—Ç, 00:01:23 —Ç–µ–∫—Å—Ç, 00:01 —Ç–µ–∫—Å—Ç
        const m = line.match(/^\[?(\d{1,2}):(\d{2})(?::(\d{2}))?\]?\s*(.*)/);
        if (m) {
          if (current) segs.push(current);
          const h = 0;
          const min = parseInt(m[1]);
          const sec = parseInt(m[2] || '0');
          const extraSec = m[3] ? parseInt(m[3]) : 0;
          const time = h * 3600 + min * 60 + sec + extraSec;
          current = { start: time, text: m[4] || '' };
        } else if (current) {
          current.text += (current.text ? ' ' : '') + line;
        }
      }
      if (current) segs.push(current);

      // –í—ã—á–∏—Å–ª—è–µ–º end
      for (let i = 0; i < segs.length; i++) {
        segs[i].end = (i < segs.length - 1) ? segs[i+1].start : segs[i].start + 30;
      }
      return segs;
    }

    // === –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ ===
    function playAt(seconds) {
      if (!audio) return;
      audio.currentTime = seconds;
      audio.play().catch(() => {
        // –ë–µ–∑–æ–ø–∞—Å–Ω–æ: –µ—Å–ª–∏ –ø–µ—Ä–≤—ã–π —Ä–∞–∑ ‚Äî –ø—Ä–æ—Å—Ç–æ –º–æ–ª—á–∞ –Ω–µ –∏–≥—Ä–∞–µ—Ç
        // (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–ª–∏–∫–Ω–µ—Ç –ø–æ –ø–ª–µ–µ—Ä—É —Å–∞–º)
      });
    }

    function playSegment(i) {
      const seg = segments[i];
      if (!seg) return;

      // –ê–∫—Ç–∏–≤–∞—Ü–∏—è
      document.querySelectorAll('.segment').forEach(s => s.classList.remove('active'));
      const el = document.querySelectorAll('.segment')[i];
      if (el) el.classList.add('active');

      playAt(seg.start);

      // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞
      el?.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // === –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ ===
    function render() {
      const el = document.getElementById('transcript');
      if (!segments.length) {
        el.innerHTML = segments.length === 0 
          ? '<p><i>–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</i></p>' 
          : '<p>–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞</p>';
        return;
      }

      el.innerHTML = segments.map((seg, i) =>
        `<div class="segment" onclick="playSegment(${i})">
          <span class="timestamp">[${formatTime(seg.start)}]</span>
          <span>${seg.text || '<i>–±–µ–∑ —Ç–µ–∫—Å—Ç–∞</i>'}</span>
        </div>`
      ).join('');
    }

    function formatTime(s) {
      s = Math.floor(s);
      const h = Math.floor(s / 3600);
      const m = Math.floor((s % 3600) / 60);
      const ss = s % 60;
      return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${ss.toString().padStart(2, '0')}`;
    }

    function setStatus(html, cls) {
      const statusEl = document.getElementById('status');
      statusEl.className = cls;
      statusEl.innerHTML = html;
    }

    // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è onclick
    window.playSegment = playSegment;
  </script>
</body>
</html>